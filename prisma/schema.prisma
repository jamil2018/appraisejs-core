generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model TestSuite {
  id          String     @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  moduleId    String
  module      Module     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  testCases   TestCase[] @relation("TestSuiteTestCases")
  tags        Tag[]
}

model Review {
  id         String       @id @default(uuid())
  testCaseId String
  reviewerId String
  status     ReviewStatus
  comments   String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  testCase   TestCase     @relation(fields: [testCaseId], references: [id])
}

model LinkedJiraTicket {
  id            String   @id @default(uuid())
  testCaseId    String
  jiraTicketId  String
  jiraTicketUrl String
  jiraStatus    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  testCase      TestCase @relation(fields: [testCaseId], references: [id])
}

model TemplateStep {
  id                   String                  @id @default(uuid())
  name                 String
  description          String?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  signature            String
  functionDefinition   String?
  type                 TemplateStepType
  icon                 TemplateStepIcon
  templateStepGroupId  String
  templateStepGroup    TemplateStepGroup       @relation("TemplateStepGroupSteps", fields: [templateStepGroupId], references: [id], onDelete: Cascade)
  parameters           TemplateStepParameter[]
  TemplateTestCaseStep TemplateTestCaseStep[]
  TestCaseStep         TestCaseStep[]
}

model TemplateStepParameter {
  id             String            @id @default(uuid())
  name           String
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  templateStepId String
  order          Int
  type           StepParameterType
  templateStep   TemplateStep      @relation(fields: [templateStepId], references: [id], onDelete: Cascade)
}

model TemplateStepGroup {
  id            String                @id @default(uuid())
  name          String
  description   String?
  type          TemplateStepGroupType @default(ACTION)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  templateSteps TemplateStep[]        @relation("TemplateStepGroupSteps")
}

model TestCase {
  id                String             @id @default(uuid())
  title             String
  description       String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  linkedJiraTickets LinkedJiraTicket[]
  reviews           Review[]
  steps             TestCaseStep[]
  TestSuite         TestSuite[]        @relation("TestSuiteTestCases")
  TestRunTestCase   TestRunTestCase[]
  tags              Tag[]
}

model TestCaseStep {
  id             String                  @id @default(uuid())
  testCaseId     String
  order          Int
  gherkinStep    String
  icon           TemplateStepIcon
  label          String
  templateStepId String
  TemplateStep   TemplateStep            @relation(fields: [templateStepId], references: [id], onDelete: Cascade)
  testCase       TestCase                @relation(fields: [testCaseId], references: [id])
  parameters     TestCaseStepParameter[]
}

model TemplateTestCase {
  id          String                 @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  steps       TemplateTestCaseStep[]
}

model TemplateTestCaseStep {
  id                 String                          @id @default(uuid())
  order              Int
  gherkinStep        String
  icon               TemplateStepIcon
  label              String
  templateTestCaseId String
  templateStepId     String
  TemplateStep       TemplateStep                    @relation(fields: [templateStepId], references: [id], onDelete: Cascade)
  templateTestCase   TemplateTestCase                @relation(fields: [templateTestCaseId], references: [id])
  parameters         TemplateTestCaseStepParameter[]
}

model TemplateTestCaseStepParameter {
  id                   String               @id @default(uuid())
  name                 String
  defaultValue         String
  order                Int
  testCaseStepId       String
  locatorId            String?
  type                 StepParameterType
  defaultLocatorId     String?
  defaultLocator       Locator?             @relation(fields: [defaultLocatorId], references: [id])
  templateTestCaseStep TemplateTestCaseStep @relation(fields: [testCaseStepId], references: [id])
}

model TestCaseStepParameter {
  id             String            @id @default(uuid())
  name           String
  value          String
  order          Int
  testCaseStepId String
  locatorId      String?
  type           StepParameterType
  Locator        Locator?          @relation(fields: [locatorId], references: [id])
  testCaseStep   TestCaseStep      @relation(fields: [testCaseStepId], references: [id])
}

model Locator {
  id                            String                          @id @default(uuid())
  name                          String
  value                         String
  createdAt                     DateTime                        @default(now())
  updatedAt                     DateTime                        @updatedAt
  locatorGroupId                String?
  locatorGroup                  LocatorGroup?                   @relation(fields: [locatorGroupId], references: [id], onDelete: Cascade)
  TemplateTestCaseStepParameter TemplateTestCaseStepParameter[]
  stepParameters                TestCaseStepParameter[]
  conflicts                     ConflictResolution[]
}

model LocatorGroup {
  id        String    @id @default(uuid())
  name      String    @unique
  route     String    @default("/")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  moduleId  String
  locators  Locator[]
  module    Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
}

model Module {
  id            String         @id @default(uuid())
  name          String
  parentId      String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  locatorGroups LocatorGroup[]
  parent        Module?        @relation("ModuleHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children      Module[]       @relation("ModuleHierarchy")
  testSuites    TestSuite[]
}

model TestRunTestCase {
  id         String                @id @default(uuid())
  testRunId  String
  testCaseId String
  status     TestRunTestCaseStatus @default(PENDING)
  result     TestRunTestCaseResult @default(UNTESTED)
  tracePath  String?
  testRun    TestRun               @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  testCase   TestCase              @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
}

model TestRun {
  id               String            @id @default(uuid())
  name             String
  runId            String            @unique @default(uuid())
  startedAt        DateTime          @default(now())
  completedAt      DateTime?
  status           TestRunStatus     @default(QUEUED)
  result           TestRunResult     @default(PENDING)
  testCases        TestRunTestCase[]
  updatedAt        DateTime          @updatedAt
  environment      Environment       @relation(fields: [environmentId], references: [id])
  environmentId    String
  tags             Tag[]
  testWorkersCount Int?              @default(1)
  browserEngine    BrowserEngine     @default(CHROMIUM)
  logs             TestRunLog?
  logPath          String?
}

model TestRunLog {
  id        String   @id @default(uuid())
  testRunId String   @unique
  logs      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  testRun   TestRun  @relation(fields: [testRunId], references: [runId], onDelete: Cascade)
}

model Environment {
  id         String    @id @default(uuid())
  name       String    @unique
  baseUrl    String
  apiBaseUrl String?
  username   String?
  password   String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  testRuns   TestRun[]
}

model Tag {
  id            String      @id @default(uuid())
  name          String
  tagExpression String
  type          TagType     @default(FILTER)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  testRuns      TestRun[]
  testSuites    TestSuite[]
  testCases     TestCase[]
}

enum TagType {
  IDENTIFIER
  FILTER
}

enum TestRunStatus {
  QUEUED
  RUNNING
  CANCELLING
  COMPLETED
  CANCELLED
}

enum TestRunTestCaseStatus {
  PENDING
  RUNNING
  COMPLETED
  CANCELLED
}

enum TestRunTestCaseResult {
  PASSED
  FAILED
  UNTESTED
}

enum TestRunResult {
  PENDING
  PASSED
  FAILED
  CANCELLED
}

enum Role {
  ADMIN
  TESTER
  REVIEWER
}

enum ReviewStatus {
  PENDING
  APPROVED
  CHANGES_REQUESTED
}

enum TestCaseStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum TestCaseResult {
  PASSED
  FAILED
  BLOCKED
  SKIPPED
  RETEST
  UNTESTED
}

enum TemplateStepType {
  ACTION
  ASSERTION
}

enum StepParameterType {
  NUMBER
  STRING
  DATE
  BOOLEAN
  LOCATOR
}

enum StepParameterValueType {
  STRING
  NUMBER
  LOCATOR
}

enum TemplateStepIcon {
  MOUSE
  NAVIGATION
  INPUT
  DOWNLOAD
  API
  STORE
  FORMAT
  DATA
  UPLOAD
  WAIT
  VALIDATION
  DEBUG
}

enum BrowserEngine {
  CHROMIUM
  FIREFOX
  WEBKIT
}

enum TemplateStepGroupType {
  ACTION
  VALIDATION
}

model ConflictResolution {
  id                  String       @id @default(uuid())
  entityType          EntityType
  entityId            String
  conflictType        ConflictType
  conflictingEntityId String?
  resolved            Boolean      @default(false)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  locator             Locator?     @relation(fields: [entityId], references: [id], onDelete: Cascade)
}

enum EntityType {
  LOCATOR
}

enum ConflictType {
  DUPLICATE_NAME
  DUPLICATE_VALUE
}
